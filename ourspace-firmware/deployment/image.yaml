{{- $image := or .suite "out/image.img" -}}
{{- $suite := or .suite "trixie" -}}

architecture: amd64

actions:
  - action: unpack
    file: out/app.tar.gz
    compression: gz

  - action: image-partition
    imagename: {{ $image }}
    imagesize: 14GB
    partitiontype: gpt
    mountpoints:
      - mountpoint: /
        partition: root0
      - mountpoint: /boot/efi
        partition: efi
        flags: [ boot ]
      - mountpoint: /data
        partition: data
    partitions:
      - name: efi
        fs: vfat
        parttype: C12A7328-F81F-11D2-BA4B-00A0C93EC93B
        start: 0%
        end: 256MB
        options: [ x-systemd.automount ]
      - name: root0
        fs: ext4
        start: 256MB
        end: 4096MB
      - name: root1
        fs: ext4
        start: 4096MB
        end: 7936MB
      - name: data
        fs: ext4
        start: 7936MB
        end: 100%

  - action: filesystem-deploy
    description: Deploying filesystem onto image

  - action: overlay
    source: fstab
    destination: /etc/

  - action: run
    chroot: true
    command: update-grub

  - action: run
    chroot: true
    command: grub-install --target=x86_64-efi --no-nvram

  - action: run
    chroot: true
    command: mkdir -p /boot/efi/EFI/BOOT && cp /boot/efi/EFI/debian/grubx64.efi /boot/efi/EFI/BOOT/BOOTX64.EFI

  - action: run
    chroot: true
    command: grub-editenv /boot/efi/grubenv create
